<!DOCTYPE html>
<html>
<head>
    <title>Animation Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        #animationContainer { 
            width: 100%; 
            height: 600px; 
            position: relative; 
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        form {
            margin: 20px 0;
        }
        textarea {
            width: 100%;
            max-width: 500px;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div>
        <h1>Animation Generator</h1>
        <form id="promptForm">
            <textarea id="prompt" rows="4" cols="50" placeholder="Describe your animation..."></textarea>
            <button type="submit">Generate Animation</button>
        </form>
        <div id="status"></div>
        <div id="animationContainer"></div>
    </div>

    <script>
        let scene, camera, renderer, controls;

        function initThreeJS() {
            // Initialize scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);

            // Initialize camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 5);

            // Initialize renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            // Clear previous content
            const container = document.getElementById('animationContainer');
            container.innerHTML = '';
            container.appendChild(renderer.domElement);

            // Add controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // Add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(0, 1, 0);
            scene.add(directionalLight);

            // Handle window resize
            window.addEventListener('resize', onWindowResize, false);

            // Start animation loop
            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            renderer.render(scene, camera);
        }

        document.getElementById('promptForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const prompt = document.getElementById('prompt').value;
            const status = document.getElementById('status');
            
            status.textContent = 'Generating animation...';
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt }),
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }

                status.textContent = 'Loading animation...';
                
                // Initialize Three.js if not already done
                if (!scene) initThreeJS();

                // Clear existing model if any
                scene.children.forEach(child => {
                    if (child.type === 'Group') scene.remove(child);
                });

                const loader = new THREE.GLTFLoader();
                
                // Load the model directly from the response
                const arrayBuffer = await response.arrayBuffer();
                loader.parse(
                    arrayBuffer,
                    '',
                    (gltf) => {
                        scene.add(gltf.scene);
                        
                        // Center and scale the model
                        const box = new THREE.Box3().setFromObject(gltf.scene);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3());
                        
                        const maxDim = Math.max(size.x, size.y, size.z);
                        const scale = 2 / maxDim;
                        gltf.scene.scale.setScalar(scale);
                        
                        gltf.scene.position.sub(center.multiplyScalar(scale));
                        
                        status.textContent = 'Animation loaded successfully!';
                    },
                    (error) => {
                        console.error('Error loading GLB:', error);
                        status.textContent = `Error loading animation: ${error.message || 'Failed to load GLB file'}`;
                    }
                );
            } catch (error) {
                console.error('Error:', error);
                status.textContent = `Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>